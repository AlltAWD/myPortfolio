---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import { Navigation } from '../components/Navigation';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Personal Portfolio' } = Astro.props;
---

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script is:inline>
      function setDarkMode() {
        const theme = localStorage.getItem('theme') || 
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }

      // Run on initial load
      setDarkMode();

      // Run after every View Transition swap
      document.addEventListener('astro:after-swap', setDarkMode);

      // Scroll Animation Observer
      document.addEventListener('astro:page-load', () => {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('active');
            }
          });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal').forEach((el) => observer.observe(el));
      });

      // Code Copy Button Logic
      document.addEventListener('astro:page-load', () => {
        const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"/></svg>`;

        document.querySelectorAll('pre').forEach((pre) => {
          // Prevent double-wrapping if the script runs twice
          if (pre.closest('.code-wrapper')) return;

          const wrapper = document.createElement('div');
          wrapper.className = 'code-wrapper group';
          
          pre.parentNode?.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);

          const button = document.createElement('button');
          button.className = 'copy-btn';
          button.innerHTML = copyIcon;
          button.ariaLabel = 'Copy code';

          button.addEventListener('click', async () => {
            const code = pre.querySelector('code')?.innerText || pre.innerText;
            try {
              await navigator.clipboard.writeText(code);
              button.innerHTML = checkIcon;
              setTimeout(() => button.innerHTML = copyIcon, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });

          wrapper.appendChild(button);
        });
      });
    </script>
    <ClientRouter />
  </head>
  <body class="min-h-screen flex flex-col">
    <Navigation client:load transition:persist="main-nav" />
    <div class="flex-1 w-full">
      <slot />
    </div>
  </body>
</html>